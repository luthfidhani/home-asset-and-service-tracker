---
import AppLayout from '../../layouts/AppLayout.astro';
import PageHeader from '../../components/ui/PageHeader.astro';
import Card from '../../components/ui/Card.astro';
import Button from '../../components/ui/Button.astro';
import Input from '../../components/ui/Input.astro';
import Select from '../../components/ui/Select.astro';
import Alert from '../../components/ui/Alert.astro';
import { supabase } from '../../lib/supabase';
import { formatDateForInput, formatCurrency } from '../../lib/utils';

const error = Astro.url.searchParams.get('error');
const preselectedAssetId = Astro.url.searchParams.get('asset_id') || '';

// Fetch assets that are active and not yet sold
const { data: soldAssets } = await supabase.from('asset_sales').select('asset_id');
const soldAssetIds = soldAssets?.map(s => s.asset_id) || [];

let assetsQuery = supabase.from('assets').select('id, name, purchase_price').eq('status', 'active').order('name');
if (soldAssetIds.length > 0 && !preselectedAssetId) {
  assetsQuery = assetsQuery.not('id', 'in', `(${soldAssetIds.join(',')})`);
}

const { data: assets } = await assetsQuery;

const assetOptions = assets?.map(a => ({ 
  value: a.id, 
  label: `${a.name} (${formatCurrency(a.purchase_price)})` 
})) || [];

const today = formatDateForInput(new Date());

// Get preselected asset details
let preselectedAsset = null;
if (preselectedAssetId) {
  const { data } = await supabase.from('assets').select('*').eq('id', preselectedAssetId).single();
  preselectedAsset = data;
}
---

<AppLayout title="Record Sale">
  <PageHeader title="Record Sale" description="Record the sale of an asset">
    <Button href="/sales" variant="ghost" slot="actions">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
      </svg>
      Back to Sales
    </Button>
  </PageHeader>
  
  {error && (
    <Alert type="error" class="mb-6" dismissible>
      {error === 'validation' ? 'Please fill in all required fields' : 
       error === 'already_sold' ? 'This asset has already been sold' : 
       'An error occurred. Please try again.'}
    </Alert>
  )}
  
  {assetOptions.length === 0 && !preselectedAssetId ? (
    <Card>
      <div class="text-center py-8">
        <svg class="w-16 h-16 mx-auto text-surface-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <h3 class="text-lg font-semibold text-surface-900">No assets available for sale</h3>
        <p class="text-surface-500 mt-1">All active assets have been sold or there are no active assets.</p>
        <div class="mt-4">
          <Button href="/assets/new" variant="secondary">Add New Asset</Button>
        </div>
      </div>
    </Card>
  ) : (
    <Card>
      <form action="/api/sales/create" method="POST" class="space-y-6" id="sale-form">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <Select
              name="asset_id"
              label="Asset"
              options={assetOptions}
              value={preselectedAssetId}
              placeholder="Select an asset"
              required
            />
            {preselectedAsset && (
              <p class="mt-2 text-sm text-surface-500">
                Purchase price: <span class="font-medium">{formatCurrency(preselectedAsset.purchase_price)}</span>
              </p>
            )}
          </div>
          
          <Input
            type="date"
            name="sold_date"
            label="Sold Date"
            value={today}
            required
          />
          
          <Input
            type="number"
            name="sold_price"
            label="Sold Price"
            placeholder="0.00"
            min="0"
            step="0.01"
            required
          />
          
          <Input
            name="buyer_name"
            label="Buyer Name"
            placeholder="e.g., John Doe"
          />
        </div>
        
        {preselectedAsset && (
          <div class="p-4 bg-surface-50 rounded-lg border border-surface-200">
            <h3 class="font-medium text-surface-900 mb-2">Profit/Loss Calculator</h3>
            <p class="text-sm text-surface-600">
              Purchase price: <span class="font-medium">{formatCurrency(preselectedAsset.purchase_price)}</span>
            </p>
            <p class="text-sm text-surface-600 mt-1">
              Profit/Loss will be calculated automatically based on the sold price.
            </p>
          </div>
        )}
        
        <div class="flex items-center justify-end gap-4 pt-4 border-t border-surface-200">
          <Button href="/sales" variant="ghost">Cancel</Button>
          <Button type="submit">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            Record Sale
          </Button>
        </div>
      </form>
    </Card>
  )}
</AppLayout>

