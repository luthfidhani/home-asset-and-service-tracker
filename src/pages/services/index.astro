---
import AppLayout from '../../layouts/AppLayout.astro';
import PageHeader from '../../components/ui/PageHeader.astro';
import Button from '../../components/ui/Button.astro';
import Card from '../../components/ui/Card.astro';
import Table from '../../components/ui/Table.astro';
import Badge from '../../components/ui/Badge.astro';
import Input from '../../components/ui/Input.astro';
import Select from '../../components/ui/Select.astro';
import EmptyState from '../../components/ui/EmptyState.astro';
import StatCard from '../../components/ui/StatCard.astro';
import { supabase } from '../../lib/supabase';
import { formatCurrency, formatDate, getServiceStatusColor, SERVICE_STATUSES } from '../../lib/utils';

// Get query params for filtering
const assetFilter = Astro.url.searchParams.get('asset_id') || '';
const statusFilter = Astro.url.searchParams.get('status') || '';
const dateFrom = Astro.url.searchParams.get('date_from') || '';
const dateTo = Astro.url.searchParams.get('date_to') || '';

// Build services query
let servicesQuery = supabase.from('services').select('*, assets(id, name)').order('service_date', { ascending: false });

if (assetFilter) {
  servicesQuery = servicesQuery.eq('asset_id', assetFilter);
}
if (statusFilter) {
  servicesQuery = servicesQuery.eq('status', statusFilter);
}
if (dateFrom) {
  servicesQuery = servicesQuery.gte('service_date', dateFrom);
}
if (dateTo) {
  servicesQuery = servicesQuery.lte('service_date', dateTo);
}

// Run queries in parallel
const [assetsResult, servicesResult] = await Promise.all([
  supabase.from('assets').select('id, name').order('name'),
  servicesQuery,
]);

const assets = assetsResult.data;
const services = servicesResult.data;

// Calculate totals from fetched data
const totalCost = services?.reduce((sum, s) => sum + (s.cost || 0), 0) || 0;
const completedCount = services?.filter(s => s.status === 'completed').length || 0;
const inProgressCount = services?.filter(s => s.status === 'process').length || 0;

const assetOptions = assets?.map(a => ({ value: a.id, label: a.name })) || [];
const statusOptions = SERVICE_STATUSES.map(s => ({ value: s.value, label: s.label }));
---

<AppLayout title="Services">
  <PageHeader title="Services" description="Track all service and repair records">
    <Button href="/services/new" slot="actions">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
      </svg>
      Add Service
    </Button>
  </PageHeader>
  
  <!-- Stats -->
  <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
    <StatCard
      title="Total Service Cost"
      value={formatCurrency(totalCost)}
      icon="service"
      color="yellow"
    />
    <StatCard
      title="Completed"
      value={completedCount}
      icon="service"
      color="green"
    />
    <StatCard
      title="In Progress"
      value={inProgressCount}
      icon="service"
      color="blue"
    />
  </div>
  
  <!-- Filters -->
  <Card class="mb-6">
    <form method="GET" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4">
      <Select
        name="asset_id"
        options={assetOptions}
        value={assetFilter}
        placeholder="All Assets"
      />
      <Select
        name="status"
        options={statusOptions}
        value={statusFilter}
        placeholder="All Status"
      />
      <Input
        type="date"
        name="date_from"
        placeholder="From Date"
        value={dateFrom}
      />
      <Input
        type="date"
        name="date_to"
        placeholder="To Date"
        value={dateTo}
      />
      <div class="flex gap-2">
        <Button type="submit" variant="secondary" class="flex-1">
          Filter
        </Button>
        {(assetFilter || statusFilter || dateFrom || dateTo) && (
          <Button href="/services" variant="ghost">
            Clear
          </Button>
        )}
      </div>
    </form>
  </Card>
  
  <!-- Services Table -->
  {services && services.length > 0 ? (
    <Card padding="none">
      <Table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Asset</th>
            <th class="hidden md:table-cell">Problem</th>
            <th class="hidden lg:table-cell">Service Place</th>
            <th>Cost</th>
            <th>Status</th>
            <th class="text-right">Actions</th>
          </tr>
        </thead>
        <tbody>
          {services.map((service) => (
            <tr>
              <td>{formatDate(service.service_date)}</td>
              <td>
                <a href={`/assets/${service.asset_id}`} class="font-medium text-primary-600 hover:text-primary-700" data-astro-prefetch>
                  {service.assets?.name || 'Unknown'}
                </a>
              </td>
              <td class="hidden md:table-cell max-w-xs truncate">{service.problem_description || '-'}</td>
              <td class="hidden lg:table-cell">{service.service_place || '-'}</td>
              <td class="font-medium">{formatCurrency(service.cost)}</td>
              <td>
                <Badge class={getServiceStatusColor(service.status)}>
                  {service.status === 'process' ? 'In Progress' : 'Completed'}
                </Badge>
              </td>
              <td class="text-right">
                <div class="flex items-center justify-end gap-2">
                  <a
                    href={`/services/${service.id}/edit`}
                    class="p-2 text-surface-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors"
                    title="Edit"
                    data-astro-prefetch
                  >
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                    </svg>
                  </a>
                  <form action="/api/services/delete" method="POST" class="inline" onsubmit="return confirm('Delete this service record?')">
                    <input type="hidden" name="id" value={service.id} />
                    <button
                      type="submit"
                      class="p-2 text-surface-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors"
                      title="Delete"
                    >
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                      </svg>
                    </button>
                  </form>
                </div>
              </td>
            </tr>
          ))}
        </tbody>
      </Table>
    </Card>
  ) : (
    <Card>
      <EmptyState
        title="No service records found"
        description={assetFilter || statusFilter || dateFrom || dateTo 
          ? "Try adjusting your filters" 
          : "Add your first service record"}
        icon="services"
      >
        <Button href="/services/new">Add Service Record</Button>
      </EmptyState>
    </Card>
  )}
</AppLayout>
